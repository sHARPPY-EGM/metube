<nav class="navbar navbar-expand-md navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">ORION</a>
    <div class="download-metrics">
      @if (activeDownloads > 0) {
        <div class="metric">
          <fa-icon [icon]="faDownload" class="text-primary" />
          <span>{{activeDownloads}} aktiv</span>
        </div>
      }
      @if (queuedDownloads > 0) {
        <div class="metric">
          <fa-icon [icon]="faClock" class="text-warning" />
          <span>{{queuedDownloads}} wartend</span>
        </div>
      }
      @if (failedDownloads > 0) {
        <div class="metric">
          <fa-icon [icon]="faTimesCircle" class="text-danger" />
          <span>{{failedDownloads}} fehlgeschlagen</span>
        </div>
      }
      @if ((totalSpeed | speed) !== '') {
        <div class="metric">
          <fa-icon [icon]="faTachometerAlt" class="text-info" />
          <span>{{totalSpeed | speed}}</span>
        </div>
      }
    </div>
  </div>
</nav>

<main role="main" class="container container-xl">
  <form #f="ngForm">
    <div class="container add-url-box">
      <!-- Main URL Input -->
      <div class="row mb-4">
        <div class="col">
          <div class="input-group input-group-lg">
            <input type="text"
              autocomplete="off"
              spellcheck="false"
              class="form-control"
              placeholder="Video- oder Playlist-URL eingeben..."
              name="addUrl"
              [(ngModel)]="addUrl"
              [disabled]="addInProgress || downloads.loading">
            <button class="btn btn-primary"
              type="submit"
              (click)="addDownload()"
              [disabled]="addInProgress || downloads.loading || !addUrl">
              @if (addInProgress) {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              }
              {{ addInProgress ? "Wird hinzugefügt..." : "Herunterladen" }}
            </button>
          </div>
        </div>
      </div>

      <!-- Quick Options -->
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text">Qualität</span>
            <select class="form-select"
              name="quality"
              [(ngModel)]="quality"
              (change)="qualityChanged()"
              [disabled]="addInProgress || downloads.loading">
              @for (q of qualities; track q) {
                <option [ngValue]="q.id">{{ q.text }}</option>
              }
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text">Format</span>
            <select class="form-select"
              name="format"
              [(ngModel)]="format"
              (change)="formatChanged()"
              [disabled]="addInProgress || downloads.loading">
              @for (f of formats; track f) {
                <option [ngValue]="f.id">{{ f.text }}</option>
              }
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <button type="button"
            class="btn btn-outline-secondary w-100 h-100"
            (click)="toggleAdvanced()">
            {{ isAdvancedOpen ? 'Optionen ausblenden' : 'Erweiterte Optionen' }}
          </button>
        </div>
      </div>

      <!-- Advanced Options -->
      <div [ngbCollapse]="!isAdvancedOpen">
        <div class="card">
          <div class="card-body">
            <div class="row g-3">
              <!-- Auto Start -->
              <div class="col-md-6">
                <div class="input-group" ngbTooltip="Wenn aktiviert, startet der Download automatisch nach dem Hinzufügen. Bei 'Nein' wird er in die Warteschlange eingereiht.">
                  <span class="input-group-text">Auto-Start</span>
                  <select class="form-select"
                    name="autoStart"
                    [(ngModel)]="autoStart"
                    (change)="autoStartChanged()"
                    [disabled]="addInProgress || downloads.loading">
                    <option [ngValue]="true">Ja</option>
                    <option [ngValue]="false">Nein</option>
                  </select>
                </div>
              </div>
              
              <!-- Name Prefix -->
              <div class="col-md-6">
                <div class="input-group" ngbTooltip="Ein Präfix, das vor jeden Dateinamen gestellt wird. Nützlich zur Sortierung oder Kategorisierung.">
                  <span class="input-group-text">Namenspräfix</span>
                  <input type="text"
                    class="form-control"
                    placeholder="Optional"
                    name="customNamePrefix"
                    [(ngModel)]="customNamePrefix"
                    [disabled]="addInProgress || downloads.loading">
                </div>
              </div>
              
              <!-- Playlist Limit -->
              <div class="col-md-6">
                <div class="input-group" ngbTooltip="Begrenzt die Anzahl der Videos, die aus einer Playlist heruntergeladen werden. 0 bedeutet unbegrenzt.">
                  <span class="input-group-text">Playlist-Limit</span>
                  <input type="number"
                    min="0"
                    class="form-control"
                    placeholder="0 = unbegrenzt"
                    name="playlistItemLimit"
                    (keydown)="isNumber($event)"
                    [(ngModel)]="playlistItemLimit"
                    [disabled]="addInProgress || downloads.loading">
                </div>
              </div>
              
              <!-- Strict Playlist Mode -->
              <div class="col-md-6" ngbTooltip="Wenn aktiviert, werden nur Playlists heruntergeladen, wenn die URL explizit auf eine Playlist verweist. Einzelne Videos in einer Playlist werden ignoriert.">
                <div class="form-check form-switch d-flex align-items-center h-100">
                  <input class="form-check-input"
                    type="checkbox"
                    role="switch"
                    id="strictMode"
                    name="playlistStrictMode"
                    [(ngModel)]="playlistStrictMode"
                    [disabled]="addInProgress || downloads.loading">
                  <label class="form-check-label" for="strictMode">
                    Strikter Playlist-Modus
                  </label>
                </div>
              </div>
              
              <!-- Subtitles (Work in Progress) -->
              <div class="col-md-6" ngbTooltip="Diese Funktion befindet sich noch in Entwicklung und ist derzeit nicht verfügbar.">
                <div class="form-check form-switch d-flex align-items-center h-100 disabled-option">
                  <input class="form-check-input"
                    type="checkbox"
                    role="switch"
                    id="subtitles"
                    name="subtitlesEnabled"
                    [(ngModel)]="subtitlesEnabled"
                    disabled>
                  <label class="form-check-label text-muted" for="subtitles">
                    <fa-icon [icon]="faClosedCaptioning" class="me-1" />
                    Untertitel herunterladen <span class="wip-badge">(Work in Progress)</span>
                  </label>
                </div>
              </div>
              
              <!-- Sound Notification -->
              <div class="col-md-6" ngbTooltip="Spielt einen kurzen Ton ab, wenn ein Download erfolgreich abgeschlossen wurde.">
                <div class="form-check form-switch d-flex align-items-center h-100">
                  <input class="form-check-input"
                    type="checkbox"
                    role="switch"
                    id="sound"
                    name="soundEnabled"
                    [(ngModel)]="soundEnabled"
                    (change)="soundEnabledChanged()">
                  <label class="form-check-label" for="sound">
                    <fa-icon [icon]="faVolumeUp" class="me-1" />
                    Ton bei Abschluss
                  </label>
                </div>
              </div>
            </div>
            
            <hr>
            
            <!-- Batch Actions -->
            <div class="row g-2">
              <div class="col-12">
                <button type="button"
                  class="btn btn-secondary w-100"
                  (click)="openBatchImportModal()">
                  <fa-icon [icon]="faFileImport" class="me-2" />
                  Mehrere URLs importieren
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Batch Import Modal -->
  <div class="modal fade" tabindex="-1" role="dialog" 
    [class.show]="batchImportModalOpen"
    [style.display]="batchImportModalOpen ? 'block' : 'none'">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">URLs importieren</h5>
          <button type="button" class="btn-close" aria-label="Schließen" (click)="closeBatchImportModal()"></button>
        </div>
        <div class="modal-body">
          <textarea [(ngModel)]="batchImportText" 
            class="form-control" 
            rows="8"
            placeholder="Eine Video-URL pro Zeile eingeben..."></textarea>
          @if (batchImportStatus) {
            <div class="mt-3">
              <small class="text-secondary">{{ batchImportStatus }}</small>
            </div>
          }
        </div>
        <div class="modal-footer">
          @if (importInProgress) {
            <button type="button" class="btn btn-danger me-auto" (click)="cancelBatchImport()">
              Abbrechen
            </button>
          }
          <button type="button" class="btn btn-outline-secondary" (click)="closeBatchImportModal()">
            Schließen
          </button>
          <button type="button" class="btn btn-primary" (click)="startBatchImport()" [disabled]="importInProgress">
            Importieren
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (downloads.loading) {
    <div class="alert alert-info" role="alert">
      <fa-icon [icon]="faClock" class="me-2" />
      Verbindung zum Server wird hergestellt...
    </div>
  }

  <!-- Downloads Section -->
  <div class="metube-section-header">Downloads</div>
  <div class="px-3 py-3 border-bottom">
    <button type="button" class="btn btn-link px-0 me-3" disabled #queueDelSelected (click)="delSelectedDownloads('queue')">
      <fa-icon [icon]="faTrashAlt" class="me-1" /> Ausgewählte abbrechen
    </button>
    <button type="button" class="btn btn-link px-0" disabled #queueDownloadSelected (click)="startSelectedDownloads('queue')">
      <fa-icon [icon]="faDownload" class="me-1" /> Ausgewählte starten
    </button>
  </div>
  <div class="overflow-auto">
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th scope="col" style="width: 3rem;">
            <app-master-checkbox #queueMasterCheckboxRef [id]="'queue'" [list]="downloads.queue" (changed)="queueSelectionChanged($event)" />
          </th>
          <th scope="col">Video</th>
          <th scope="col" style="width: 8rem;">Tempo</th>
          <th scope="col" style="width: 6rem;">ETA</th>
          <th scope="col" style="width: 7rem;">Aktionen</th>
        </tr>
      </thead>
      <tbody>
        @for (download of downloads.queue | keyvalue: asIsOrder; track download.value.id) {
          <tr [class.disabled]='download.value.deleting'>
            <td>
              <app-slave-checkbox [id]="download.key" [master]="queueMasterCheckboxRef" [checkable]="download.value" />
            </td>
            <td>
              <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-2">
                <span class="flex-grow-1" [title]="download.value.filename">{{ download.value.title }}</span>
                <div class="download-progressbar">
                  @if (download.value.status === 'preparing') {
                    <div class="progress">
                      <div class="progress-bar" style="width: 100%">Vorbereiten...</div>
                    </div>
                  } @else {
                    <div class="progress">
                      <div class="progress-bar" [style.width.%]="download.value.percent || 0">
                        {{ (download.value.percent || 0) | number:'1.0-0' }}%
                      </div>
                    </div>
                  }
                </div>
              </div>
            </td>
            <td>{{ download.value.speed | speed }}</td>
            <td>{{ download.value.eta | eta }}</td>
            <td>
              <div class="d-flex gap-1">
                @if (download.value.status === 'pending') {
                  <button type="button" class="btn btn-link" title="Starten" (click)="downloadItemByKey(download.key)">
                    <fa-icon [icon]="faDownload" />
                  </button>
                }
                <button type="button" class="btn btn-link text-danger" title="Abbrechen" (click)="delDownload('queue', download.key)">
                  <fa-icon [icon]="faTrashAlt" />
                </button>
                <a href="{{download.value.url}}" target="_blank" class="btn btn-link" title="Quelle öffnen">
                  <fa-icon [icon]="faExternalLinkAlt" />
                </a>
              </div>
            </td>
          </tr>
        }
        @empty {
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              Keine aktiven Downloads
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Completed Section -->
  <div class="metube-section-header">Abgeschlossen</div>
  <div class="px-3 py-3 border-bottom">
    <button type="button" class="btn btn-link px-0 me-3" disabled #doneDelSelected (click)="delSelectedDownloads('done')">
      <fa-icon [icon]="faTrashAlt" class="me-1" /> Ausgewählte löschen
    </button>
    <button type="button" class="btn btn-link text-success px-0 me-3" disabled #doneClearCompleted (click)="clearCompletedDownloads()">
      <fa-icon [icon]="faCheckCircle" class="me-1" /> Fertige löschen
    </button>
    <button type="button" class="btn btn-link text-danger px-0 me-3" disabled #doneClearFailed (click)="clearFailedDownloads()">
      <fa-icon [icon]="faTimesCircle" class="me-1" /> Fehlerhafte löschen
    </button>
    <button type="button" class="btn btn-link px-0 me-3" disabled #doneRetryFailed (click)="retryFailedDownloads()">
      <fa-icon [icon]="faRedoAlt" class="me-1" /> Fehlerhafte wiederholen
    </button>
    <button type="button" class="btn btn-link px-0" disabled #doneDownloadSelected (click)="downloadSelectedFiles()">
      <fa-icon [icon]="faDownload" class="me-1" /> Ausgewählte herunterladen
    </button>
  </div>
  <div class="overflow-auto">
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th scope="col" style="width: 3rem;">
            <app-master-checkbox #doneMasterCheckboxRef [id]="'done'" [list]="downloads.done" (changed)="doneSelectionChanged($event)" />
          </th>
          <th scope="col">Video</th>
          <th scope="col" style="width: 8rem;">Größe</th>
          <th scope="col" style="width: 8rem;">Aktionen</th>
        </tr>
      </thead>
      <tbody>
        @for (download of downloads.done | keyvalue: asIsOrder; track download.value.id) {
          <tr [class.disabled]='download.value.deleting'>
            <td>
              <app-slave-checkbox [id]="download.key" [master]="doneMasterCheckboxRef" [checkable]="download.value" />
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                @if (download.value.status === 'finished') {
                  <fa-icon [icon]="faCheckCircle" class="text-success" />
                }
                @if (download.value.status === 'error') {
                  <fa-icon [icon]="faTimesCircle" class="text-danger" />
                }
                <span [ngbTooltip]="buildResultItemTooltip(download.value)">
                  @if (download.value.filename) {
                    <a href="{{buildDownloadLink(download.value)}}" target="_blank">{{ download.value.title }}</a>
                  } @else {
                    <span>{{ download.value.title }}</span>
                    @if (download.value.msg) {
                      <br><small class="text-muted">{{ download.value.msg }}</small>
                    }
                    @if (download.value.error) {
                      <br><small class="text-danger">Fehler: {{ download.value.error }}</small>
                    }
                  }
                </span>
              </div>
            </td>
            <td>
              @if (download.value.size) {
                {{ download.value.size | fileSize }}
              }
            </td>
            <td>
              <div class="d-flex gap-1">
                @if (download.value.status === 'error') {
                  <button type="button" class="btn btn-link" title="Wiederholen" (click)="retryDownload(download.key, download.value)">
                    <fa-icon [icon]="faRedoAlt" />
                  </button>
                }
                @if (download.value.filename) {
                  <a href="{{buildDownloadLink(download.value)}}" download class="btn btn-link text-success" title="Herunterladen">
                    <fa-icon [icon]="faDownload" />
                  </a>
                }
                <a href="{{download.value.url}}" target="_blank" class="btn btn-link" title="Quelle öffnen">
                  <fa-icon [icon]="faExternalLinkAlt" />
                </a>
                <button type="button" class="btn btn-link text-danger" title="Löschen" (click)="delDownload('done', download.key)">
                  <fa-icon [icon]="faTrashAlt" />
                </button>
              </div>
            </td>
          </tr>
        }
        @empty {
          <tr>
            <td colspan="4" class="text-center text-muted py-4">
              Keine abgeschlossenen Downloads
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</main>

<footer class="footer">
  <div class="container text-center">
    <div class="footer-content">
      Created by sHARPPY / Adrian <span class="heart">❤</span>
    </div>
  </div>
</footer>
